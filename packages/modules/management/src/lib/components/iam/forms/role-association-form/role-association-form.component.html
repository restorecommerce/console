<form
  novalidate
  vclForm
  (submit)="onSubmit()"
  [formGroup]="form"
>
  <vcl-form-control-group>
    <vcl-label>Role</vcl-label>
    <vcl-select
      [clearable]="true"
      placeholder="Select role"
      [search]="true"
    >
      <vcl-select-list formControlName="role">
        @for (role of roles$ | async; track role.id) {
        <vcl-select-list-item [value]="role.id">
          {{ role.name }}
          <vcl-sub-label>{{ role.description }}</vcl-sub-label>
        </vcl-select-list-item>
        }
      </vcl-select-list>
    </vcl-select>
    <vcl-hint-error error="required">This field is required.</vcl-hint-error>
  </vcl-form-control-group>

  <fieldset>
    <legend>Scoping targets</legend>

    <div formArrayName="targets">
      @for ( _ of targets.controls; track $index; let i = $index) {
      <div
        class="row align-items-center"
        [formGroupName]="i"
      >
        <div class="flex pr-1">
          <vcl-form-control-group>
            <vcl-label>Instance type</vcl-label>
            <vcl-select>
              <vcl-select-list formControlName="instanceType">
                <vcl-select-list-item [value]="INSTANCE_TYPE_ORG">
                  Organization
                </vcl-select-list-item>

                <vcl-select-list-item [value]="INSTANCE_TYPE_USER">
                  User
                </vcl-select-list-item>
              </vcl-select-list>
            </vcl-select>
          </vcl-form-control-group>
        </div>

        <div class="flex pl-1">
          <vcl-form-control-group>
            <vcl-label>Instance ID</vcl-label>

            <vcl-select [search]="true">
              <vcl-select-list formControlName="instanceId">
                @let type = targets.at(i).get('instanceType')?.value; @if (type)
                { @for (opt of getInstanceIdOptions(type) | async; track
                opt.value) {
                <vcl-select-list-item [value]="opt.value">
                  {{ opt.label }}
                </vcl-select-list-item>
                } }
              </vcl-select-list>
            </vcl-select>
          </vcl-form-control-group>
        </div>

        <div>
          <button
            vcl-button
            square
            class="transparent"
            title="Remove"
            style="height: auto"
            (click)="removeTargetRow(i)"
          >
            <!-- class="icon " -->
            <vcl-icon icon="mdi mdi-close"></vcl-icon>
          </button>
        </div>
      </div>
      }

      <!-- <vcl-hint-error
        [error]="'duplicateTargets'"
        *ngIf="targets.errors?.duplicateTargets"
      >
        Duplicate targets are not allowed.
      </vcl-hint-error>
      <vcl-hint-error
        [error]="'atLeastOne'"
        *ngIf="targets.errors?.atLeastOne"
      >
        Add at least one target.
      </vcl-hint-error> -->

      <button
        vcl-button
        type="button"
        class="scale85p"
        (click)="addTargetRow()"
      >
        + Add target
      </button>
    </div>
  </fieldset>

  <!-- Buttons -->
  <div class="loose-button-group row justify-end mt-4">
    <button
      vcl-button
      type="button"
      class="transparent"
    >
      Cancel
    </button>

    <button
      vcl-button
      type="submit"
    >
      Save
    </button>
  </div>
</form>
