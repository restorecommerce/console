<!-- filter-sort-card.component.html -->
<div
  class="fs-card"
  role="dialog"
  aria-label="Filter and sort"
>
  <header class="fs-header">
    <h3>Filter &amp; Sort — {{ schema.title }}</h3>
  </header>

  <section class="fs-body">
    <!-- Block operator -->
    <div class="row align-items-center">
      <span class="mb-2">Match rows using:</span>
      <vcl-radio-group [(value)]="blockOperator">
        <vcl-radio-button value="and"></vcl-radio-button> AND
        <vcl-radio-button value="or"></vcl-radio-button> OR
      </vcl-radio-group>
    </div>

    <!-- Dynamic rows -->
    <div class="rows">
      <div
        class="row item"
        *ngFor="let r of rows; let i = index"
      >
        <!-- Field -->
        <div class="third">
          <vcl-form-control-group>
            <vcl-label>Field</vcl-label>
            <vcl-select>
              <vcl-select-list [(ngModel)]="r.fieldPath">
                <vcl-select-list-item [value]="null"
                  >Select a field…</vcl-select-list-item
                >
                @for (f of fields; track $index) {
                <vcl-select-list-item [value]="f.path">
                  {{ f.label }}
                </vcl-select-list-item>
                }
              </vcl-select-list>
            </vcl-select>
          </vcl-form-control-group>
        </div>

        <!-- Operation -->
        @if (r.fieldPath) {
        <div class="third">
          <vcl-form-control-group>
            <vcl-label>Operation</vcl-label>
            <vcl-select>
              <vcl-select-list [(ngModel)]="r.op">
                <vcl-select-list-item [value]="null"
                  >Select…</vcl-select-list-item
                >
                @for (op of fieldOps(r.fieldPath); track $index) {
                <vcl-select-list-item [value]="op">
                  {{ op }}
                </vcl-select-list-item>
                }
              </vcl-select-list>
            </vcl-select>
          </vcl-form-control-group>
        </div>
        } @if (r.fieldPath && r.op; as op) { @switch (op) { @case ('between') {
        @switch (fieldType(r.fieldPath)) { @case ('date') {
        <div class="half">
          <vcl-form-control-group>
            <vcl-label>From</vcl-label>
            <vcl-input-field>
              <input
                vclInput
                type="date"
                [value]="r.value?.from || ''"
              />
            </vcl-input-field>
          </vcl-form-control-group>
        </div>

        <div class="half">
          <vcl-form-control-group>
            <vcl-label>To</vcl-label>
            <vcl-input-field>
              <input
                vclInput
                type="date"
                [value]="r.value?.to || ''"
              />
            </vcl-input-field>
          </vcl-form-control-group>
        </div>
        } @default {
        <div class="half">
          <vcl-form-control-group>
            <vcl-label>Min</vcl-label>
            <vcl-input-field>
              <input
                vclInput
                type="number"
                [value]="r.value?.min ?? ''"
              />
            </vcl-input-field>
          </vcl-form-control-group>
        </div>

        <div class="half">
          <vcl-form-control-group>
            <vcl-label>Max</vcl-label>
            <vcl-input-field>
              <input
                vclInput
                type="number"
                [value]="r.value?.max ?? ''"
              />
            </vcl-input-field>
          </vcl-form-control-group>
        </div>
        } } } @case ('in') {
        <div class="third">
          <vcl-form-control-group>
            <vcl-label>Values</vcl-label>
            @switch (fieldType(r.fieldPath)) { @case ('enum') {
            <vcl-select>
              <vcl-select-list>
                @for ( o of fieldOptions(r.fieldPath); track $index) {
                <vcl-select-list-item [value]="o.value">
                  {{ o.label }}
                </vcl-select-list-item>
                }
              </vcl-select-list>
            </vcl-select>
            } @default {
            <vcl-input-field>
              <input
                vclInput
                placeholder="a, b, c"
              />
            </vcl-input-field>
            } }
          </vcl-form-control-group>
        </div>
        } @default {
        <div class="third">
          <vcl-form-control-group>
            <vcl-label>Value</vcl-label>

            @switch (r.fieldPath) { @case ('enum') {
            <vcl-select>
              <vcl-select-list>
                @for ( o of fieldOptions(r.fieldPath); track $index) {
                <vcl-select-list-item [value]="o.value">
                  {{ o.label }}
                </vcl-select-list-item>
                }
              </vcl-select-list>
            </vcl-select>
            } @default {
            <vcl-input-field>
              @switch (r.fieldPath) { @case ('number') {
              <input
                type="number"
                vclInput
                [(ngModel)]="r.value"
              />
              } @case ('date') {
              <input
                type="date"
                vclInput
                [(ngModel)]="r.value"
              />
              } @default {
              <input
                type="text"
                vclInput
                [(ngModel)]="r.value"
              />
              } }
            </vcl-input-field>
            } }
          </vcl-form-control-group>
        </div>
        } } }

        <button
          vcl-button
          square
          class="transparent"
          title="Remove row"
          (click)="removeRow(i)"
        >
          <vcl-icon icon="vcl:close"></vcl-icon>
        </button>
      </div>
    </div>

    <div>
      <button
        vcl-button
        class="transparent"
        (click)="addRow()"
      >
        <vcl-icon icon="vcl:add"></vcl-icon>
      </button>
    </div>

    <hr class="sp" />

    <!-- Sort -->
    <div class="row">
      <div class="twoThird">
        <vcl-form-control-group>
          <vcl-label>Sort by</vcl-label>
          <vcl-select>
            <vcl-select-list [(ngModel)]="sort.by">
              <vcl-select-list-item [value]="null">None</vcl-select-list-item>
              @for (s of sortKeys; track s.key) {
              <vcl-select-list-item [value]="s.key">
                {{ s.label }}
              </vcl-select-list-item>
              }
            </vcl-select-list>
          </vcl-select>
        </vcl-form-control-group>
      </div>

      <div class="oneThird sort-dir">
        <vcl-radio-group [(value)]="sort.dir">
          <vcl-radio-button value="asc"></vcl-radio-button> ↑ Asc
          <vcl-radio-button value="desc"></vcl-radio-button> ↓ Desc
        </vcl-radio-group>
      </div>
    </div>
  </section>

  <div class="loose-button-group p-3 row justify-content-end">
    <button
      vcl-button
      class="transparent"
      type="button"
      (click)="clearAll()"
    >
      Reset
    </button>
    <button
      vcl-button
      type="button"
      (click)="submit()"
      class="emphasized"
    >
      Apply
    </button>
  </div>
</div>
